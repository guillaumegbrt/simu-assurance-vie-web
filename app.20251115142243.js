/* global Chart, dayjs */
// Bannière d'erreur pour debug
(function(){ window.addEventListener('error', e=>{ const b=document.getElementById('errorBanner'); if(b){ b.textContent = 'Erreur JavaScript: '+(e.message||''); b.style.display='block'; } console.error(e.error||e); }); })();
try{ dayjs.extend(dayjs_plugin_utc); dayjs.extend(dayjs_plugin_customParseFormat); }catch(e){ console.warn('Dayjs plugins', e); }

const $=(s,c=document)=>c.querySelector(s); const $$=(s,c=document)=>Array.from(c.querySelectorAll(s)); const byId=id=>document.getElementById(id);

// Providers
const StooqProvider={ symbols:{ CAC40:'^cac', SP500:'^spx' }, async fetchMonthly(symbol){ const urlM=`https://stooq.com/q/d/l/?s=${encodeURIComponent(symbol)}&i=m`; const resM=await fetch(urlM); const csvM=await resM.text(); if(csvM.includes('Date,Open,High,Low,Close')) return parseStooqCsv(csvM); const urlD=`https://stooq.com/q/d/l/?s=${encodeURIComponent(symbol)}&i=d`; const resD=await fetch(urlD); const csvD=await resD.text(); return monthlyResample(parseStooqCsv(csvD)); }};
const FMPProvider={ async fetchMonthly(isin,key){ if(!key) return null; const urlSearch=`https://financialmodelingprep.com/api/v3/search-name?query=${isin}&apikey=${key}`; const r=await fetch(urlSearch); const j=await r.json(); const sym=j?.[0]?.symbol; if(!sym) return null; const urlHist=`https://financialmodelingprep.com/api/v3/historical-price-full/${sym}?apikey=${key}`; const rH=await fetch(urlHist); const jH=await rH.json(); const hist=jH?.historical; if(!hist) return null; const series=hist.map(x=>({date:x.date, close:x.close})).filter(x=>x.date && Number.isFinite(x.close)); return monthlyResample(series); }};
async function openFigiMapISIN(isin,key){ const headers={'Content-Type':'application/json'}; if(key) headers['X-OPENFIGI-APIKEY']=key; const r=await fetch('https://cors-anywhere.herokuapp.com/https://api.openfigi.com/v3/mapping',{method:'POST',headers,body:JSON.stringify([{idType:'ID_ISIN',idValue:isin}])}); const j=await r.json(); const d=j?.[0]?.data?.[0]; if(!d) return null; return {ticker:d.ticker,exch:d.exchCode||'', name:d.name||d.securityDescription||''}; }

// Parsing helpers (sans regex)
function splitLines(text){
  return text.split('').join('').split('');
}
function parseStooqCsv(csv){ const rows=splitLines(csv.trim()).slice(1); return rows.filter(Boolean).map(r=>{ const cols=r.split(','); const d=cols[0]; const c=+cols[4]; return {date:d, close:c}; }).filter(x=>x.date && Number.isFinite(x.close)); }
function monthlyResample(daily){ const byM=new Map(); for(const {date,close} of daily){ const m=dayjs(date).utc().format('YYYY-MM'); byM.set(m,{date:dayjs(date).utc().endOf('month').format('YYYY-MM-DD'), close}); } return [...byM.values()].sort((a,b)=>a.date.localeCompare(b.date)); }
function toMonthlyReturns(series){ const out=[]; for(let i=1;i<series.length;i++){ out.push({date:series[i].date, r: series[i].close/series[i-1].close - 1}); } return out; }

// State
const state={ api:{ openfigiKey:'', fmpKey:'' }, euro:{ feeIn:0, rates:[] }, ucs:[], scenarios:[ {start:'',init:10000,prog:0,freq:'Mensuel',progStart:'',progEnd:'',alloc:{}}, {start:'',init:1000,prog:100,freq:'Mensuel',progStart:'',progEnd:'',alloc:{}}, {start:'',init:1000,prog:100,freq:'Mensuel',progStart:'',progEnd:'',alloc:{}} ]};
function save(){ localStorage.setItem('simu-av', JSON.stringify(state)); }
function load(){ const s=localStorage.getItem('simu-av'); if(s){ try{ Object.assign(state, JSON.parse(s)); }catch{} } }

// UI builders
function buildEuroRates(){ const host=byId('euroRates'); host.innerHTML=''; const tbl=document.createElement('table'); tbl.innerHTML='<thead><tr><th>Année</th><th>Taux annuel net (%)</th><th></th></tr></thead><tbody></tbody>'; const tb=tbl.querySelector('tbody'); for(const row of state.euro.rates){ const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="number" value="${row.year}" class="er-year"/></td><td><input type="number" step="0.01" value="${row.rate}" class="er-rate"/></td><td><button class="del" type="button">×</button></td>`; tb.appendChild(tr); tr.querySelector('.er-year').onchange=e=>{row.year=+e.target.value; save();}; tr.querySelector('.er-rate').onchange=e=>{row.rate=+e.target.value; save();}; tr.querySelector('.del').onclick=()=>{ state.euro.rates=state.euro.rates.filter(x=>x!==row); buildEuroRates(); save(); }; }
  host.appendChild(tbl); }

function buildUCTable(){ const tb=$('#ucTable tbody'); tb.innerHTML=''; for(const uc of state.ucs){ const tr=document.createElement('tr'); tr.innerHTML=`<td><input value="${uc.isin||''}" class="uc-isin" placeholder="ISIN"/></td><td><span class="nom-tag">${uc.name||''}</span></td><td>${uc.source||''}</td><td>${uc.csvData?'✔️':''}</td><td><button class="del" type="button">×</button></td>`; tb.appendChild(tr); tr.querySelector('.uc-isin').addEventListener('change', onIsinChange(uc)); tr.querySelector('.del').onclick=()=>{ state.ucs=state.ucs.filter(x=>x!==uc); buildUCTable(); buildAllAlloc(); save(); }; } }
function onIsinChange(uc){ return async e=>{ uc.isin=e.target.value.trim(); uc.name=''; uc.ticker=''; uc.source=''; save(); if(!uc.isin) return; try{ const m = await openFigiMapISIN(uc.isin, state.api.openfigiKey).catch(()=>null); if(m?.ticker){ uc.ticker=m.ticker; uc.exch=m.exch; uc.name=m.name||''; uc.source='openfigi'; save(); } await fetchUCSeries(uc); }catch(err){ console.warn('Stooq failed:', err); try{ const fmpData = await FMPProvider.fetchMonthly(uc.isin, state.api.fmpKey); if(fmpData?.length){ uc.series = toMonthlyReturns(fmpData); uc.source = 'fmp'; save(); }else{ throw new Error('No data from FMP'); } }catch(err2){ console.warn('FMP failed:', err2); alert(`Historique introuvable pour ${uc.isin}. Fournis un CSV.`); } } buildUCTable(); buildAllAlloc(); } }

function buildAllAlloc(){ [1,2,3].forEach(i=> buildAllocForScenario(i)); updateAllSums(); }
function buildAllocForScenario(idx){ const host=$(`.alloc[data-alloc="${idx}"]`); host.innerHTML=''; const alloc=state.scenarios[idx-1].alloc || (state.scenarios[idx-1].alloc={}); if(alloc['Fonds_Euro']===undefined) alloc['Fonds_Euro']= (idx===1?100:0); host.appendChild(makeAllocRow(idx,'Fonds_Euro','Fonds Euro',alloc['Fonds_Euro'])); for(const uc of state.ucs){ const key=ucKey(uc); if(alloc[key]===undefined) alloc[key]=0; const label=uc.name||uc.isin||'UC'; host.appendChild(makeAllocRow(idx,key,label,alloc[key])); } }
function makeAllocRow(idx,key,label,val){ const wrap=document.createElement('div'); wrap.className='alloc-row'; wrap.innerHTML=`<label>${label}<input type="number" class="alloc-val" step="0.1" data-s="${idx}" data-k="${key}" value="${val}"/></label>`; wrap.querySelector('input').addEventListener('input', e=>{ const s=+e.target.dataset.s; const k=e.target.dataset.k; const v=+e.target.value||0; state.scenarios[s-1].alloc[k]=v; save(); updateSumFor(s); }); return wrap; }
function updateAllSums(){ [1,2,3].forEach(updateSumFor); }
function updateSumFor(idx){ const alloc=state.scenarios[idx-1].alloc||{}; const total=Object.values(alloc).reduce((a,b)=>a+(+b||0),0); const sumEl=$(`[data-sum="${idx}"]`); if(sumEl){ sumEl.textContent=(Math.round(total*10)/10).toString(); const box=sumEl.closest('.sum'); if(box){ if(total>100.0001) box.classList.add('over'); else box.classList.remove('over'); } } }

// CSV upload
byId('csvUpload')?.addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; const text=await f.text(); const lines = splitLines(text.trim()); const [h, ...rows] = lines; const headers = h.toLowerCase().split(','); const iD = headers.indexOf('date'), iC=headers.indexOf('close'); const data = rows.map(r=>{ const cols=r.split(','); return {date: cols[iD], close: +cols[iC]}; }).filter(x=>x.date && Number.isFinite(x.close)); if(state.ucs.length===0){ alert('Ajoute d’abord une UC.'); return; } const uc=state.ucs[state.ucs.length-1]; uc.csvData=data; uc.source='upload'; if(!uc.name) uc.name='CSV import'; save(); buildUCTable(); buildAllAlloc(); });

// Fetch UC series
const EXCH_TO_STOOQ={ US:'.US', FR:'.FR', DE:'.DE', NL:'.NL', GB:'.UK', ES:'.ES', IT:'.IT', PL:'.PL', JP:'.JP', CA:'.CA' };
async function fetchUCSeries(uc){ if(uc.csvData) return toMonthlyReturns(uc.csvData); if(!uc.ticker) throw new Error('Ticker indisponible (mapping ISIN échoué)'); const trials=new Set([uc.ticker]); if(uc.exch && EXCH_TO_STOOQ[uc.exch]) trials.add(`${uc.ticker}${EXCH_TO_STOOQ[uc.exch]}`); ['.US','.FR','.DE','.UK','.NL','.ES','.IT','.JP','.CA','.PL'].forEach(sfx=>trials.add(`${uc.ticker}${sfx}`)); for(const tk of trials){ try{ const m=await StooqProvider.fetchMonthly(tk); if(m?.length){ uc.series = toMonthlyReturns(m); uc.ticker=tk; uc.source = uc.source || 'stooq'; return uc.series; } }catch{} } throw new Error('Série introuvable sur Stooq'); }
function ucKey(uc){ return uc.isin; }

// Simulation & chart
function monthDiff(a,b){ const da=dayjs(a), db=dayjs(b); return (db.year()-da.year())*12 + (db.month()-da.month()); }
function scheduleProg(freq){ return freq==='Mensuel'?1: freq==='Trimestriel'?3:12; }
function simulateScenario(s, allMonths, rByUC, euroRateByYear, feeInPct){ const alloc=s.alloc||{}; const euroW=(alloc['Fonds_Euro']??0)/100; const ucW=Object.entries(alloc).filter(([k])=>k!=='Fonds_Euro').map(([k,v])=>[k,(v||0)/100]).filter(([,w])=>w>0); let val=0; const out=[]; const step=scheduleProg(s.freq||'Mensuel'); const start=s.start? dayjs(s.start): allMonths[0]; const ps=s.progStart? dayjs(s.progStart): start; const pe=s.progEnd? dayjs(s.progEnd): allMonths.at(-1); const feeIn=(feeInPct||0)/100; for(const d of allMonths){ let inflow=0; if(d.isSame(start,'month')) inflow+=(+s.init||0); if(d.isAfter(ps.subtract(1,'day'))&&d.isBefore(pe.add(1,'day'))){ const m=monthDiff(ps.startOf('month'), d.startOf('month')); if(m%step===0) inflow+=(+s.prog||0); } const netInflow=inflow*(1-feeIn); const euroRm = Math.pow(1 + (euroRateByYear[d.year()]??0)/100, 1/12) - 1; let ucRm=0; if(ucW.length){ ucRm = ucW.reduce((acc,[k,w])=> acc + w * (rByUC[k]?.get(d.format('YYYY-MM'))??0), 0); } const mixRm = euroW*euroRm + (1-euroW)*ucRm; val=(val+netInflow)*(1+mixRm); out.push({date:d.format('YYYY-MM-DD'), value:val}); } return out; }
function mkMonthAxis(list){ const months=new Set(); for(const arr of list){ const src=Array.isArray(arr)? arr:[]; for(const el of src){ const d=typeof el==='string'? el: el.date; const m=dayjs(d).utc().format('YYYY-MM-01'); if(m!=='Invalid Date') months.add(m); } } return [...months].sort().map(d=>dayjs(d)); }
let chart; function renderChart(xMonths,{indices,scenarios}){ const ctx=byId('chart').getContext('2d'); const colors=['#60a5fa','#34d399','#f472b6','#fbbf24','#22d3ee','#a78bfa','#ef4444','#10b981','#eab308','#94a3b8','#fb7185','#14b8a6']; const ds=[]; indices.forEach((it,i)=>{ ds.push({label:it.label, data: alignSeries(xMonths, it.series.map(x=>({x:x.date.slice(0,7), y:x.close}))), yAxisID:'y2', borderColor:colors[i], backgroundColor:'transparent', tension:.15}); }); scenarios.forEach((sc,i)=>{ ds.push({label:sc.label, data: alignSeries(xMonths, sc.data.map(x=>({x:x.date.slice(0,7), y:x.value}))), yAxisID:'y1', borderColor:colors[(i+indices.length)%colors.length], backgroundColor:'transparent', tension:.15}); }); if(chart) chart.destroy(); chart=new Chart(ctx,{ type:'line', data:{labels:xMonths, datasets:ds}, options:{ interaction:{mode:'nearest',intersect:false}, scales:{ y1:{type:'linear',position:'left',title:{display:true,text:'€ (Scénarios)'}}, y2:{type:'linear',position:'right',grid:{drawOnChartArea:false},title:{display:true,text:'Indice (niveau)'}} }, plugins:{legend:{position:'top'}} }}); }
function alignSeries(xMonths, pts){ const map=new Map(pts.map(p=>[p.x,p.y])); return xMonths.map(m=> map.get(m) ?? null); }

// Run & handlers
async function runSimulation(){ try{ state.api.openfigiKey = byId('openfigiKey')?.value.trim() || ''; state.api.fmpKey = byId('fmpKey')?.value.trim() || ''; state.euro.feeIn = +(byId('feeInEuro')?.value || 0); $$('.scenario').forEach((box,idx)=>{ const s=state.scenarios[idx]; s.start=box.querySelector('.s-date')?.value||''; s.init=+(box.querySelector('.s-init')?.value||0); const prog=box.querySelector('.s-prog'); s.prog=prog? +prog.value||0 : 0; const freq=box.querySelector('.s-freq'); s.freq=freq? freq.value : 'Mensuel'; const ps=box.querySelector('.s-prog-start'); s.progStart=ps? ps.value : ''; const pe=box.querySelector('.s-prog-end'); s.progEnd=pe? pe.value : ''; }); save(); const [cac, spx] = await Promise.all([ StooqProvider.fetchMonthly(StooqProvider.symbols.CAC40), StooqProvider.fetchMonthly(StooqProvider.symbols.SP500) ]); const rCAC = toMonthlyReturns(cac), rSPX = toMonthlyReturns(spx); const rByUC={}; for(const uc of state.ucs){ if(!uc.series){ try{ await fetchUCSeries(uc); }catch{} } if(uc.series){ const m=new Map(uc.series.map(x=>[x.date.slice(0,7), x.r])); rByUC[ucKey(uc)] = m; } } const allMonths = mkMonthAxis([cac, spx, ...Object.values(rByUC).map(m=>[...m.keys()].map(k=>k+'-01'))]); const euroByYear = Object.fromEntries(state.euro.rates.map(x=>[x.year, +x.rate||0])); const res=[]; for(let i=0;i<3;i++){ res.push({label:`Scénario ${i+1}`, data: simulateScenario(state.scenarios[i], allMonths, rByUC, euroByYear, state.euro.feeIn)}); const rCACmap=new Map(rCAC.map(x=>[x.date.slice(0,7),x.r])); res.push({label:`Scénario ${i+1} (si CAC40)`, data: simulateScenario({...state.scenarios[i], alloc:{'Fonds_Euro':0,'__IDX__CAC40':100}}, allMonths, {'__IDX__CAC40': rCACmap}, euroByYear, state.euro.feeIn)}); const rSPXmap=new Map(rSPX.map(x=>[x.date.slice(0,7),x.r])); res.push({label:`Scénario ${i+1} (si S&P500)`, data: simulateScenario({...state.scenarios[i], alloc:{'Fonds_Euro':0,'__IDX__SP500':100}}, allMonths, {'__IDX__SP500': rSPXmap}, euroByYear, state.euro.feeIn)}); } renderChart(allMonths.map(d=>d.format('YYYY-MM')), { indices:[{label:'CAC40 (niveau)', series:cac},{label:'S&P500 (niveau)', series:spx}], scenarios: res }); }catch(e){ console.error(e); alert('Erreur pendant la simulation (voir console).'); } }

function attachHandlers(){ byId('addRate')?.addEventListener('click', ()=>{ state.euro.rates.push({year: dayjs().year(), rate:2}); buildEuroRates(); save(); }); byId('addUC')?.addEventListener('click', ()=>{ state.ucs.push({isin:'', name:'', ticker:'', source:''}); buildUCTable(); buildAllAlloc(); save(); }); byId('run')?.addEventListener('click', runSimulation); byId('export')?.addEventListener('click', ()=>{ const data=JSON.stringify(state,null,2); const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`etude_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href); }); byId('import')?.addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const text=await f.text(); const obj=JSON.parse(text); Object.assign(state, obj); save(); init(true); }catch{ alert('Fichier JSON invalide'); } }); }

function buildDefaults(){ if(!Array.isArray(state.euro.rates)) state.euro.rates=[]; if(state.euro.rates.length===0){ const y=dayjs().year(); state.euro.rates=[{year:y-1,rate:2},{year:y,rate:2}]; } }
function init(skipAttach){ load(); buildDefaults(); byId('feeInEuro').value=state.euro.feeIn||0; byId('openfigiKey').value=state.api.openfigiKey||''; byId('fmpKey').value=state.api.fmpKey||''; buildEuroRates(); buildUCTable(); buildAllAlloc(); if(!skipAttach) attachHandlers(); }

document.addEventListener('DOMContentLoaded', ()=> init(false));
